{{ define "chart" }}
	<div
		_="def updateChart()
			   get the getComputedStyle(me) then set computedStyles to it
			   set cols to computedStyles.getPropertyValue('--chart-settings-cols')
			   set rows to computedStyles.getPropertyValue('--chart-settings-rows')

			   set total to rows * cols

			   set images to the children of #images
			   for img in images index i
			   	   if i >= total
			   	   	   set img's @aria-hidden to true
			   	   else
			   	   	   set img's @aria-hidden to false
			   	   end
			   end

			   set #text's @rows to rows
			   set #text's @columns to cols
		   end

		   init
			   updateChart()
			   show me
		   end

		   -- mobile replace on search
		   on chartImages(src, title, caption)
		       set imgs to the children of #images
			   set imgTxt to the children of #text
			   send replace(src: src, title: title, caption: caption) to imgs[$replaceIndex]
		   end

		   on chartUpdate
			   updateChart()
		   end

		   on chartTextPlacement(value)
			   if value is 'hide' or value is 'inline' or value is 'overlay'
			       set <chart-image/>'s @text-placement to value
				   add [@text-placement=hide] to #images-text
			   end
			   if value is 'left' or value is 'below' or value is 'right'
				   set #images-text's @text-placement to value
				   add [@text-placement=hide] to <chart-image/>
			   end
		   end

		   on chartImagesShape(value)
		       set <chart-image/>'s @shape to value
		   end

		   on popstate(state) from window
			   -- assume we're back from the search
			   if not state
				   toggle between .hidden and .block on <footer/>
				   toggle between .hidden and .grid on #search-mobile
			   end
		   end"
		id="chart"
		class="shadow-lg grid place-items-center gap-4"
		style="background-color: {{ .BgColor }}; display: none;"
	>
		<chart-images-text id="images-text" text-placement="hide">
			<h1
				_="on update(val) get the markdown(val) then set my.innerHTML to it"
				id="chart-title"
				class="font-condensed place-self-center"
				style="color: {{ .TextColor }};"
				slot="title"
			>
				{{ .Title }}
			</h1>
			<ul
				_="init
					   send update(images: me) to #text
				   end
				   on drop(target)
					   send update(images: me) to #text

				   -- sortable events
				   on move(dragged)
					   send update(images: me) to #text
				       set the dragged's @data-was-dragging to true
				   on update(item, newIndex)
				       set images to the children of me
					   for img in images index i
						   set the img's @index to i
					   end
				   on end(item)
					   set the item's @data-was-dragging to false"
				id="images"
				class="grid"
				slot="images"
			>
				{{ $textColor := .TextColor }}
				{{ $shape := .ImagesShape }}

				{{ range $i := .Images }}
					<chart-image
						_="on touchend
							   if @data-was-dragging
								   remove @data-was-dragging from me
								   exit
							   end
							   wait 150ms -- helps make things feel smooth
							   toggle between .hidden and .block on <footer/>
							   set $replaceIndex to my.index
							   send open to #search-mobile
							   call history.pushState('search-mobile-open', null, 'search-mobile')
							end"
						class="aria-hidden:hidden sortable-item"
						index="{{ $i }}"
						title="{{ .Title }}"
						caption="{{ .Caption }}"
						src="{{ .URL }}"
						text-color="{{ $textColor }}"
						text-placement="hide"
						shape="{{ $shape }}"
						aria-hidden="false"
					>
					</chart-image>
				{{ end }}
			</ul>
			<chart-text id="text" slot="text" columns="{{ .ColumnCount }}" rows="{{ .RowCount }}"></chart-text>
		</chart-images-text>
	</div>
{{ end }}
